# 리덕스미들웨어 : Redux-thunk
- https://react.vlpt.us/redux-middleware/05-redux-thunk-with-promise.html

이 미들웨어를 사용하면 액션 객체가 아닌 함수를 디스패치 할 수 있습니다. redux-thunk는 리덕스의 창시자인 Dan Abramov가 만들었으며, 리덕스 공식 매뉴얼에서도 비동기 작업을 처리하기 위하여 미들웨어를 사용하는 예시를 보여줍니다.

단순한 객체를 전달했던 리덕스는 Redux-thunk를 만나서, 함수를 통해 비동기 처리가 가능해진 것이다. 
그러나 라이브러리가 Weekly 다운로드 수가 140만대에 이를 정도로 폭발적이다. 

해당 함수에서 dispatch 와 getState 를 파라미터로 받아와주어야 합니다. 이 함수를 만들어주는 함수를 우리는 thunk 라고 부릅니다.

- yarn add redux-thunk

## 기존의 액션을 객체를 함수로 변경하기
Redux-middleware.js 를 살펴보자. 
```javascript 
  export const increaseAsync = () => dispatch => {
    setTimeout(() => dispatch(increase()), 1000);
  };
  export const decreaseAsync = () => dispatch => {
    setTimeout(() => dispatch(decrease()), 1000);
  };
```

이렇게 진행되는 redux-thunk는 setTimeout에 따라 1초 뒤에 값을 적용할 것이다. 

## redux-thunk로 프로미스 다루기
먼저, Promise 를 사용하여 데이터를 반환하는 가짜 API 함수를 만들어보도록 하겠습니다.

## 리액트 라우터 적용하기
- yarn add react-router-dom 

## 7-5 까지 따라왔다면..
<div align="center"><img src="https://i.imgur.com/8a7uQJQ.gif" width="90%"></div>

잘 작동하긴 하는데 두 가지 문제점이 있습니다. 위 스크린 녹화 결과에서도 확인 할 수 있는데요,

특정 포스트를 열은다음에 뒤로 갔을 때, 포스트 목록을 또 다시 불러오게 되면서 로딩중...이 나타나게 됩니다.
특정 포스트를 읽고, 뒤로 간 다음에 다른 포스트를 열면 이전에 열었던 포스트가 잠깐 보여졌다가 로딩중... 이 보여지게됩니다.
위 두가지 문제로 인하여 사용자에게 좋지 못한 경험을 제공하게 될 수 있습니다.

이 문제를 해결하는 방법은 다음 섹션에서 다뤄보도록 하겠습니다.

### 포스트 목록 재로딩 문제 해결하기
포스트 목록이 재로딩 되는 문제를 해결하는 방법은 두가지가 있습니다. 첫번째는 만약 데이터가 이미 존재한다면 요청을 하지 않도록 하는 방법입니다. 한번 PostListContainer를 다음과 같이 수정해보세요.

두번째 방법은 로딩을 새로하긴 하는데, 로딩중... 을 띄우지 않는 것입니다. 두번째 방법의 장점은 사용자에게 좋은 경험을 제공하면서도 뒤로가기를 통해 다시 포스트 목록을 조회 할 때 최신 데이터를 보여줄 수 있다는 것 입니다.
asyncUtils.js 의 handleAsyncActions 함수를 다음과 같이 수정해주세요.

### 그러나, 포스트 조회시 재로딩 문제 해결하기
특정 포스트를 조회하는 과정에서 재로딩 문제를 해결하려면, 방금 했던 방식으로는 처리 할 수 없습니다. 왜냐하면 어떤 파라미터가 주어졌냐에 따라 다른 결과물이 있기 때문이죠. 이 문제를 해결하는 방식 또한 두가지가 있습니다. 첫번째 해결방식은 컴포넌트가 언마운트될때 포스트 내용을 비우도록 하는 것 입니다. 이 작업을 하려면 posts 리덕스 모듈에 CLEAR_POST 라는 액션을 준비해주어야 합니다.

### 그러나 문제는 이미 읽었던 포스트를 불러오려고 할 경우에도 새로 요청하는 문제
posts 모듈에서 관리하는 상태의 구조를 바꿔야 합니다.

### thunk와 라우터 연동하기 
thunk 함수 내에서 라우터를 사용해야 될 때도 있습니다. 예를 들자면, 로그인 요청을 하는데 로그인이 성공 할 시 / 경로로 이동시키고, 실패 할 시 경로를 유지 하는 형태로 구현 할 수도 있죠.

- customHistory 만들어서 적용하기
  - yarn add history 설치하기 
  thunk 에서 라우터의 history 객체를 사용하려면, BrowserHistory 인스턴스를 직접 만들어서 적용해야합니다. index.js 를 다음과 같이 수정해주세요.